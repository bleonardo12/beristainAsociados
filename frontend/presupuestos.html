<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Metadatos básicos -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Presupuestos - Área Socios | Beristain & Asociados</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/favicon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

    <!-- CSS personalizado -->
    <link rel="stylesheet" type="text/css" href="styles.css">

    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #1a365d;
            --secondary-color: #2d5a8a;
            --accent-color: #c9a961;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-light: #f8fafc;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        .header-presupuestos {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-area img {
            width: 80px;
            height: auto;
            border-radius: 8px;
        }

        .header-title h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .header-title p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Container principal */
        .main-container {
            max-width: 1400px;
            margin: 3rem auto;
            padding: 0 2rem;
        }

        /* Cards de información */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .info-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .info-card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .info-card h3 {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .info-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Sección principal */
        .content-section {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--primary-color);
        }

        .btn-primary-custom {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary-custom:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
        }

        /* Tabla de presupuestos */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-light);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-aprobado {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rechazado {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-enviado {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-action {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 6px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            margin-right: 0.25rem;
        }

        .btn-action:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-action.btn-edit {
            background: #0891b2;
        }

        .btn-action.btn-view {
            background: #6366f1;
        }

        .btn-action.btn-pdf {
            background: #dc2626;
        }

        .btn-action.btn-delete {
            background: #991b1b;
        }

        /* Formulario de presupuesto */
        .form-presupuesto {
            display: none;
            background: var(--bg-light);
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .form-presupuesto.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-cancel {
            background: var(--border-color);
            color: var(--text-dark);
        }

        .btn-cancel:hover {
            background: #cbd5e1;
        }

        /* Calculadora UMA */
        .uma-calculator {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .uma-calculator h6 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-aplicar-uma {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-aplicar-uma:hover {
            background: #0284c7;
            transform: translateY(-2px);
        }

        /* Section dividers */
        .section-divider {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin: 2rem 0 1.5rem 0;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Alertas */
        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-info i {
            font-size: 1.5rem;
            color: #3b82f6;
        }

        /* Modal detalles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-content-custom {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header-custom h3 {
            color: var(--primary-color);
            font-family: 'Playfair Display', serif;
        }

        .btn-close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .detail-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .detail-value {
            color: var(--text-light);
        }

        /* Dropdown estado */
        .estado-selector {
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
        }

        .estado-selector select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .info-cards {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .table-container {
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.5rem;
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-presupuestos">
        <div class="header-content">
            <div class="logo-area">
                <img src="img/logonuevoB.jpg" alt="Beristain & Asociados">
                <div class="header-title">
                    <h1>Área de Socios</h1>
                    <p>Sistema Profesional de Presupuestos</p>
                </div>
            </div>
            <div class="user-info">
                <a href="index.html" class="btn-logout">
                    <i class="bi bi-house-fill"></i>
                    Volver al inicio
                </a>
                <button id="logoutBtn" class="btn-logout">
                    <i class="bi bi-box-arrow-right"></i>
                    Cerrar sesión
                </button>
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <div class="main-container">
        <!-- Cards de información -->
        <div class="info-cards">
            <div class="info-card">
                <div class="info-card-icon">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <h3>Total Presupuestos</h3>
                <div class="value" id="totalPresupuestos">0</div>
            </div>
            <div class="info-card">
                <div class="info-card-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <h3>Pendientes</h3>
                <div class="value" id="totalPendientes">0</div>
            </div>
            <div class="info-card">
                <div class="info-card-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3>Aprobados</h3>
                <div class="value" id="totalAprobados">0</div>
            </div>
            <div class="info-card">
                <div class="info-card-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <h3>Monto Total</h3>
                <div class="value" id="montoTotal">$0</div>
            </div>
        </div>

        <!-- Alerta informativa -->
        <div class="alert-info">
            <i class="bi bi-info-circle-fill"></i>
            <div>
                <strong>Área Privada</strong> - Sistema profesional exclusivo para socios del estudio. Los presupuestos se almacenan localmente en su navegador. Utilice la calculadora UMA para honorarios profesionales según normativa del Colegio de Abogados.
            </div>
        </div>

        <!-- Sección de presupuestos -->
        <div class="content-section">
            <div class="section-header">
                <h2>Listado de Presupuestos</h2>
                <button id="btnNuevoPresupuesto" class="btn-primary-custom">
                    <i class="bi bi-plus-circle"></i>
                    Nuevo Presupuesto
                </button>
            </div>

            <!-- Formulario de presupuesto -->
            <div id="formPresupuesto" class="form-presupuesto">
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);" id="formTitle">
                    <i class="bi bi-file-earmark-plus me-2"></i>Crear Nuevo Presupuesto
                </h3>
                <form id="presupuestoForm">
                    <input type="hidden" id="presupuestoId">

                    <!-- DATOS DEL CLIENTE -->
                    <div class="section-divider">
                        <i class="bi bi-person-fill"></i>
                        DATOS DEL CLIENTE
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente">Nombre Completo *</label>
                            <input type="text" id="cliente" class="form-control" required placeholder="Nombre del cliente">
                        </div>
                        <div class="form-group">
                            <label for="dni">DNI *</label>
                            <input type="text" id="dni" class="form-control" required placeholder="12345678">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="form-control" placeholder="email@ejemplo.com">
                        </div>
                        <div class="form-group">
                            <label for="telefono">Teléfono</label>
                            <input type="tel" id="telefono" class="form-control" placeholder="+54 11 1234-5678">
                        </div>
                    </div>

                    <!-- SERVICIO JURÍDICO -->
                    <div class="section-divider">
                        <i class="bi bi-briefcase-fill"></i>
                        SERVICIO JURÍDICO
                    </div>

                    <div class="form-group">
                        <label for="servicio">Área/Servicio *</label>
                        <select id="servicio" class="form-control" required>
                            <option value="">Seleccione un servicio...</option>
                            <optgroup label="RAMA PENAL">
                                <option value="Penal - Incidente de excarcelación y/o exención de prisión">Incidente de excarcelación y/o exención de prisión</option>
                                <option value="Penal - Pedido y audiencia de suspensión de juicio a prueba">Pedido y audiencia de suspensión de juicio a prueba</option>
                                <option value="Penal - Acta de juicio abreviado">Acta de juicio abreviado</option>
                                <option value="Penal - Actuación hasta la clausura de la instrucción">Actuación hasta la clausura de la instrucción</option>
                                <option value="Penal - Actuación desde la clausura hasta sentencia">Actuación desde la clausura de la instrucción hasta la sentencia</option>
                                <option value="Penal - Parte Querellante">Parte Querellante</option>
                                <option value="Penal - Redacción de denuncia penal" data-uma="3">Redacción de denuncia penal (3 UMA)</option>
                            </optgroup>
                            <optgroup label="RAMA CIVIL">
                                <option value="Civil - Sucesiones">Sucesiones</option>
                                <option value="Civil - Declaración de insania">Declaración de insania</option>
                                <option value="Civil - Consulta verbal" data-uma="0.5">Consulta verbal (0.5 UMA)</option>
                                <option value="Civil - Consulta con informe" data-uma="1">Consulta con informe (1 UMA)</option>
                                <option value="Civil - Redacción de carta documento" data-uma="1">Redacción de carta documento (1 UMA)</option>
                                <option value="Civil - Estudio de actuaciones" data-uma="2">Estudio o información de actuaciones (2 UMA)</option>
                                <option value="Civil - Trámites administrativos" data-uma="3">Trámites administrativos (3 UMA)</option>
                                <option value="Civil - Trámites ante IGJ" data-uma="5">Trámites ante IGJ (CABA) (5 UMA)</option>
                                <option value="Civil - Redacción contrato de locación" data-uma="2">Redacción contrato de locación (Mín. 2 UMA)</option>
                                <option value="Civil - Redacción boleto compra venta" data-uma="3">Redacción boleto compra venta (Mín. 3 UMA)</option>
                            </optgroup>
                            <optgroup label="RAMA COMERCIAL">
                                <option value="Comercial - Juicio ejecutivo contra bancos">Juicio ejecutivo contra bancos</option>
                                <option value="Comercial - Juicio ordinario contra bancos">Juicio ordinario contra bancos</option>
                            </optgroup>
                            <optgroup label="ACCIDENTES DE TRÁNSITO">
                                <option value="Accidentes - Reclamo administrativo">Reclamo administrativo</option>
                                <option value="Accidentes - Daños y perjuicios">Daños y perjuicios</option>
                                <option value="Accidentes - Reclamo completo">Reclamo completo (administrativo + judicial)</option>
                            </optgroup>
                            <optgroup label="OTROS">
                                <option value="Otro servicio">Otro servicio (especificar en descripción)</option>
                            </optgroup>
                        </select>
                        <small class="text-muted">Servicios marcados con UMA tienen honorarios mínimos establecidos</small>
                    </div>

                    <div class="form-group">
                        <label for="descripcion">Descripción Detallada del Caso *</label>
                        <textarea id="descripcion" class="form-control" required placeholder="Describa brevemente la situación del cliente y las gestiones a realizar..."></textarea>
                    </div>

                    <!-- HONORARIOS Y GASTOS -->
                    <div class="section-divider">
                        <i class="bi bi-cash-coin"></i>
                        HONORARIOS Y GASTOS
                    </div>

                    <!-- Calculadora UMA -->
                    <div class="uma-calculator">
                        <h6><i class="bi bi-calculator me-2"></i>Calculadora UMA (Unidad Mínima Arancelaria)</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="valorUMA">Valor actual de 1 UMA ($)</label>
                                <input type="number" id="valorUMA" class="form-control" value="0" min="0" step="0.01" placeholder="Ej: 28000">
                                <small class="text-muted">Según Colegio de Abogados</small>
                            </div>
                            <div class="form-group">
                                <label for="cantidadUMA">Cantidad de UMA</label>
                                <input type="number" id="cantidadUMA" class="form-control" value="0" min="0" step="0.5" placeholder="Ej: 3">
                            </div>
                            <div class="form-group">
                                <label>Total en UMA</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" id="totalUMA" class="form-control" readonly>
                                </div>
                                <button type="button" class="btn-aplicar-uma" id="btnAplicarUMA">
                                    <i class="bi bi-arrow-down me-1"></i>Aplicar a Honorarios
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="honorarios">Honorarios Profesionales ($) *</label>
                            <input type="number" id="honorarios" class="form-control" required min="0" step="0.01" placeholder="0.00">
                            <small class="text-muted">Ingrese monto directo o use calculadora UMA arriba</small>
                        </div>
                        <div class="form-group">
                            <label for="gastosAdmin">Gastos Administrativos ($)</label>
                            <input type="number" id="gastosAdmin" class="form-control" value="0" min="0" step="0.01" placeholder="0.00">
                            <small class="text-muted">Tasas, certificados, traslados, etc.</small>
                        </div>
                        <div class="form-group">
                            <label for="iva">IVA (%)</label>
                            <select id="iva" class="form-control">
                                <option value="0">Sin IVA (Exento)</option>
                                <option value="21">21% IVA</option>
                                <option value="10.5">10.5% IVA</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="anticipo">Anticipo (ARS)</label>
                            <input type="number" id="anticipo" class="form-control" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="saldo">Saldo (ARS)</label>
                            <input type="number" id="saldo" class="form-control" placeholder="0.00" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Total Estimado</label>
                            <div class="input-group">
                                <span class="input-group-text bg-success text-white fw-bold">$</span>
                                <input type="text" id="totalEstimado" class="form-control fw-bold fs-5 text-success" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- CONDICIONES COMERCIALES -->
                    <div class="section-divider">
                        <i class="bi bi-card-checklist"></i>
                        CONDICIONES COMERCIALES
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="formaPago">Forma de Pago</label>
                            <select id="formaPago" class="form-control">
                                <optgroup label="PAGO ÚNICO">
                                    <option value="Pago único al inicio">Pago único al inicio</option>
                                    <option value="Pago único al finalizar">Pago único al finalizar el trámite</option>
                                    <option value="Pago único antes de sentencia">Pago único antes de la sentencia</option>
                                </optgroup>
                                <optgroup label="PAGO EN ETAPAS (DOS PAGOS)">
                                    <option value="50% adelanto + 50% al finalizar">50% adelanto + 50% al finalizar</option>
                                    <option value="50% al inicio + 50% antes de sentencia">50% al inicio + 50% antes de sentencia</option>
                                    <option value="40% adelanto + 60% al finalizar">40% adelanto + 60% al finalizar</option>
                                    <option value="30% adelanto + 70% al finalizar">30% adelanto + 70% al finalizar</option>
                                    <option value="20% adelanto + 80% al finalizar">20% adelanto + 80% al finalizar</option>
                                </optgroup>
                                <optgroup label="PAGO EN ETAPAS (TRES PAGOS)">
                                    <option value="33% al inicio + 33% a mitad + 34% al finalizar">33% al inicio + 33% a mitad del proceso + 34% al finalizar</option>
                                    <option value="30% al inicio + 30% a mitad + 40% al finalizar">30% al inicio + 30% a mitad + 40% al finalizar</option>
                                    <option value="25% al inicio + 25% a mitad + 50% al finalizar">25% al inicio + 25% a mitad + 50% al finalizar</option>
                                </optgroup>
                                <optgroup label="CUOTAS">
                                    <option value="Pago en 2 cuotas mensuales">Pago en 2 cuotas mensuales</option>
                                    <option value="Pago en 3 cuotas mensuales">Pago en 3 cuotas mensuales</option>
                                    <option value="Pago en 4 cuotas mensuales">Pago en 4 cuotas mensuales</option>
                                    <option value="Pago en 6 cuotas mensuales">Pago en 6 cuotas mensuales</option>
                                </optgroup>
                                <optgroup label="HONORARIOS A RESULTADO">
                                    <option value="A éxito - 25% sobre lo obtenido">A éxito - 25% sobre lo obtenido</option>
                                    <option value="A éxito - 30% sobre lo obtenido">A éxito - 30% sobre lo obtenido</option>
                                    <option value="A éxito - 35% sobre lo obtenido">A éxito - 35% sobre lo obtenido</option>
                                    <option value="Mínimo garantizado + % sobre excedente">Mínimo garantizado + % sobre excedente</option>
                                </optgroup>
                                <optgroup label="OTRAS MODALIDADES">
                                    <option value="Transferencia bancaria">Transferencia bancaria</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta de crédito/débito">Tarjeta de crédito/débito</option>
                                    <option value="Mixto">Mixto (especificar en observaciones)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cuotas">Cantidad de Cuotas</label>
                            <input type="number" id="cuotas" class="form-control" placeholder="1" min="1">
                        </div>
                        <div class="form-group">
                            <label for="vigencia">Vigencia del Presupuesto</label>
                            <select id="vigencia" class="form-control">
                                <option value="15">15 días</option>
                                <option value="30" selected>30 días</option>
                                <option value="45">45 días</option>
                                <option value="60">60 días</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="vencimiento">Fecha de Vencimiento del Pago</label>
                        <input type="date" id="vencimiento" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="notas">Observaciones/Aclaraciones</label>
                        <textarea id="notas" class="form-control" placeholder="Información adicional, condiciones especiales, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="detalleAdicional">Detalle Adicional (Opcional)</label>
                        <textarea id="detalleAdicional" class="form-control" rows="4" placeholder="Documentación requerida, plazos específicos, aclaraciones sobre el proceso, etc."></textarea>
                        <small class="text-muted">Este campo aparecerá en el PDF si se completa</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary-custom">
                            <i class="bi bi-save"></i>
                            <span id="btnSubmitText">Guardar Presupuesto</span>
                        </button>
                        <button type="button" id="btnCancelar" class="btn-primary-custom btn-cancel">
                            <i class="bi bi-x-circle"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tabla de presupuestos -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>DNI</th>
                            <th>Servicio</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="presupuestosTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                                No hay presupuestos registrados. Haga clic en "Nuevo Presupuesto" para comenzar.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de detalles -->
    <div id="modalDetalles" class="modal-backdrop">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3>Detalles del Presupuesto</h3>
                <button class="btn-close-modal" onclick="closeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Verificar autenticación
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }

        // Cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                sessionStorage.removeItem('authenticated');
                sessionStorage.removeItem('loginTime');
                window.location.href = 'login.html';
            }
        });

        // Calculadoras automáticas
        document.getElementById('valorUMA').addEventListener('input', calcularTotalUMA);
        document.getElementById('cantidadUMA').addEventListener('input', calcularTotalUMA);
        document.getElementById('btnAplicarUMA').addEventListener('click', aplicarUMAaHonorarios);
        document.getElementById('servicio').addEventListener('change', autoCompletarUMA);

        document.getElementById('honorarios').addEventListener('input', calcularTotal);
        document.getElementById('gastosAdmin').addEventListener('input', calcularTotal);
        document.getElementById('iva').addEventListener('change', calcularTotal);
        document.getElementById('anticipo').addEventListener('input', calcularSaldo);

        function calcularTotalUMA() {
            const valorUMA = parseFloat(document.getElementById('valorUMA').value) || 0;
            const cantidadUMA = parseFloat(document.getElementById('cantidadUMA').value) || 0;
            const total = valorUMA * cantidadUMA;
            document.getElementById('totalUMA').value = total.toLocaleString('es-AR', { minimumFractionDigits: 2 });
        }

        function aplicarUMAaHonorarios() {
            const valorUMA = parseFloat(document.getElementById('valorUMA').value) || 0;
            const cantidadUMA = parseFloat(document.getElementById('cantidadUMA').value) || 0;
            const total = valorUMA * cantidadUMA;
            if (total > 0) {
                document.getElementById('honorarios').value = total.toFixed(2);
                calcularTotal();
            }
        }

        function autoCompletarUMA() {
            const selectedOption = document.getElementById('servicio').selectedOptions[0];
            const umaValue = selectedOption.getAttribute('data-uma');
            if (umaValue) {
                document.getElementById('cantidadUMA').value = umaValue;
                calcularTotalUMA();
            }
        }

        function calcularTotal() {
            const honorarios = parseFloat(document.getElementById('honorarios').value) || 0;
            const gastosAdmin = parseFloat(document.getElementById('gastosAdmin').value) || 0;
            const ivaPercentage = parseFloat(document.getElementById('iva').value) || 0;

            const subtotal = honorarios + gastosAdmin;
            const ivaAmount = (subtotal * ivaPercentage) / 100;
            const total = subtotal + ivaAmount;

            document.getElementById('totalEstimado').value = total.toLocaleString('es-AR', { minimumFractionDigits: 2 });
            calcularSaldo();
        }

        function calcularSaldo() {
            const totalText = document.getElementById('totalEstimado').value.replace(/\./g, '').replace(',', '.');
            const total = parseFloat(totalText) || 0;
            const anticipo = parseFloat(document.getElementById('anticipo').value) || 0;
            const saldo = total - anticipo;
            document.getElementById('saldo').value = saldo.toFixed(2);
        }

        // Gestión de presupuestos
        class PresupuestosManager {
            constructor() {
                this.presupuestos = this.loadPresupuestos();
                this.editingId = null;
                this.init();
            }

            loadPresupuestos() {
                const stored = localStorage.getItem('presupuestos');
                return stored ? JSON.parse(stored) : [];
            }

            savePresupuestos() {
                localStorage.setItem('presupuestos', JSON.stringify(this.presupuestos));
                this.updateStats();
                this.render();
            }

            generateNumeroPresupuesto() {
                const hoy = new Date();
                return 'PPTO-' + hoy.getFullYear() +
                    String(hoy.getMonth() + 1).padStart(2, '0') +
                    String(hoy.getDate()).padStart(2, '0') + '-' +
                    String(hoy.getHours()).padStart(2, '0') +
                    String(hoy.getMinutes()).padStart(2, '0');
            }

            addPresupuesto(data) {
                const presupuesto = {
                    id: Date.now(),
                    numero: this.generateNumeroPresupuesto(),
                    fecha: new Date().toLocaleDateString('es-AR'),
                    cliente: data.cliente,
                    dni: data.dni,
                    email: data.email,
                    telefono: data.telefono,
                    servicio: data.servicio,
                    descripcion: data.descripcion,
                    valorUMA: parseFloat(data.valorUMA) || 0,
                    cantidadUMA: parseFloat(data.cantidadUMA) || 0,
                    honorarios: parseFloat(data.honorarios),
                    gastosAdmin: parseFloat(data.gastosAdmin) || 0,
                    iva: parseFloat(data.iva) || 0,
                    anticipo: parseFloat(data.anticipo) || 0,
                    saldo: parseFloat(data.saldo) || 0,
                    total: parseFloat(data.total),
                    formaPago: data.formaPago,
                    cuotas: parseInt(data.cuotas) || 1,
                    vigencia: data.vigencia,
                    vencimiento: data.vencimiento,
                    notas: data.notas,
                    detalleAdicional: data.detalleAdicional,
                    estado: 'pendiente'
                };
                this.presupuestos.unshift(presupuesto);
                this.savePresupuestos();
            }

            updatePresupuesto(id, data) {
                const index = this.presupuestos.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.presupuestos[index] = {
                        ...this.presupuestos[index],
                        cliente: data.cliente,
                        dni: data.dni,
                        email: data.email,
                        telefono: data.telefono,
                        servicio: data.servicio,
                        descripcion: data.descripcion,
                        valorUMA: parseFloat(data.valorUMA) || 0,
                        cantidadUMA: parseFloat(data.cantidadUMA) || 0,
                        honorarios: parseFloat(data.honorarios),
                        gastosAdmin: parseFloat(data.gastosAdmin) || 0,
                        iva: parseFloat(data.iva) || 0,
                        anticipo: parseFloat(data.anticipo) || 0,
                        saldo: parseFloat(data.saldo) || 0,
                        total: parseFloat(data.total),
                        formaPago: data.formaPago,
                        cuotas: parseInt(data.cuotas) || 1,
                        vigencia: data.vigencia,
                        vencimiento: data.vencimiento,
                        notas: data.notas,
                        detalleAdicional: data.detalleAdicional
                    };
                    this.savePresupuestos();
                }
            }

            deletePresupuesto(id) {
                if (confirm('¿Está seguro que desea eliminar este presupuesto?')) {
                    this.presupuestos = this.presupuestos.filter(p => p.id !== id);
                    this.savePresupuestos();
                }
            }

            updateEstado(id, nuevoEstado) {
                const presupuesto = this.presupuestos.find(p => p.id === id);
                if (presupuesto) {
                    presupuesto.estado = nuevoEstado;
                    this.savePresupuestos();
                }
            }

            editPresupuesto(id) {
                const p = this.presupuestos.find(pres => pres.id === id);
                if (p) {
                    this.editingId = id;
                    document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Presupuesto';
                    document.getElementById('btnSubmitText').textContent = 'Actualizar Presupuesto';
                    document.getElementById('presupuestoId').value = id;
                    document.getElementById('cliente').value = p.cliente;
                    document.getElementById('dni').value = p.dni || '';
                    document.getElementById('email').value = p.email || '';
                    document.getElementById('telefono').value = p.telefono || '';
                    document.getElementById('servicio').value = p.servicio;
                    document.getElementById('descripcion').value = p.descripcion;
                    document.getElementById('valorUMA').value = p.valorUMA || 0;
                    document.getElementById('cantidadUMA').value = p.cantidadUMA || 0;
                    document.getElementById('honorarios').value = p.honorarios;
                    document.getElementById('gastosAdmin').value = p.gastosAdmin || 0;
                    document.getElementById('iva').value = p.iva || 0;
                    document.getElementById('anticipo').value = p.anticipo || 0;
                    document.getElementById('formaPago').value = p.formaPago;
                    document.getElementById('cuotas').value = p.cuotas || 1;
                    document.getElementById('vigencia').value = p.vigencia || 30;
                    document.getElementById('vencimiento').value = p.vencimiento || '';
                    document.getElementById('notas').value = p.notas || '';
                    document.getElementById('detalleAdicional').value = p.detalleAdicional || '';

                    calcularTotalUMA();
                    calcularTotal();

                    document.getElementById('formPresupuesto').classList.add('active');
                    document.getElementById('formPresupuesto').scrollIntoView({ behavior: 'smooth' });
                }
            }

            viewDetails(id) {
                const p = this.presupuestos.find(pres => pres.id === id);
                if (!p) return;

                const modalBody = document.getElementById('modalBody');
                const subtotal = p.honorarios + p.gastosAdmin;
                const ivaAmount = (subtotal * p.iva) / 100;

                modalBody.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Número:</div>
                        <div class="detail-value"><strong>${p.numero || 'N/A'}</strong></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Fecha:</div>
                        <div class="detail-value">${p.fecha}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Cliente:</div>
                        <div class="detail-value"><strong>${p.cliente}</strong></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">DNI:</div>
                        <div class="detail-value">${p.dni || 'N/A'}</div>
                    </div>
                    ${p.email ? `<div class="detail-row"><div class="detail-label">Email:</div><div class="detail-value">${p.email}</div></div>` : ''}
                    ${p.telefono ? `<div class="detail-row"><div class="detail-label">Teléfono:</div><div class="detail-value">${p.telefono}</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Servicio:</div>
                        <div class="detail-value">${p.servicio}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Descripción:</div>
                        <div class="detail-value">${p.descripcion}</div>
                    </div>
                    ${p.valorUMA > 0 ? `<div class="detail-row"><div class="detail-label">UMA:</div><div class="detail-value">${p.cantidadUMA} UMA × $${p.valorUMA.toLocaleString('es-AR')}</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Honorarios:</div>
                        <div class="detail-value"><strong>$${p.honorarios.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</strong></div>
                    </div>
                    ${p.gastosAdmin > 0 ? `<div class="detail-row"><div class="detail-label">Gastos Admin:</div><div class="detail-value">$${p.gastosAdmin.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Subtotal:</div>
                        <div class="detail-value">$${subtotal.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</div>
                    </div>
                    ${p.iva > 0 ? `<div class="detail-row"><div class="detail-label">IVA (${p.iva}%):</div><div class="detail-value">$${ivaAmount.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">TOTAL:</div>
                        <div class="detail-value"><strong style="color: var(--primary-color); font-size: 1.2rem;">$${p.total.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</strong></div>
                    </div>
                    ${p.anticipo > 0 ? `
                        <div class="detail-row"><div class="detail-label">Anticipo:</div><div class="detail-value">$${p.anticipo.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</div></div>
                        <div class="detail-row"><div class="detail-label">Saldo:</div><div class="detail-value">$${p.saldo.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</div></div>
                    ` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Forma de Pago:</div>
                        <div class="detail-value">${p.formaPago}</div>
                    </div>
                    ${p.cuotas > 1 ? `<div class="detail-row"><div class="detail-label">Cuotas:</div><div class="detail-value">${p.cuotas} cuotas</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Vigencia:</div>
                        <div class="detail-value">${p.vigencia} días</div>
                    </div>
                    ${p.vencimiento ? `<div class="detail-row"><div class="detail-label">Vencimiento:</div><div class="detail-value">${new Date(p.vencimiento).toLocaleDateString('es-AR')}</div></div>` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Estado:</div>
                        <div class="detail-value">
                            <span class="status-badge status-${p.estado}">
                                ${p.estado.charAt(0).toUpperCase() + p.estado.slice(1)}
                            </span>
                        </div>
                    </div>
                    ${p.notas ? `<div class="detail-row"><div class="detail-label">Observaciones:</div><div class="detail-value">${p.notas}</div></div>` : ''}
                    ${p.detalleAdicional ? `<div class="detail-row"><div class="detail-label">Detalle Adicional:</div><div class="detail-value">${p.detalleAdicional}</div></div>` : ''}
                `;
                document.getElementById('modalDetalles').classList.add('active');
            }

            exportToPDF(id) {
                const p = this.presupuestos.find(pres => pres.id === id);
                if (!p) return;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Colores
                const primaryColor = [26, 54, 93];
                const accentColor = [201, 169, 97];
                const grayColor = [100, 100, 100];
                const lightGray = [200, 200, 200];

                let yPos = 20;

                // ENCABEZADO
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 40, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('BERISTAIN & ASOCIADOS', 105, 18, { align: 'center' });

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Estudio Jurídico', 105, 26, { align: 'center' });

                doc.setFontSize(10);
                doc.text('Araujo 319 - CABA', 105, 32, { align: 'center' });

                yPos = 50;

                // INFORMACIÓN DEL PRESUPUESTO
                doc.setTextColor(...grayColor);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('PRESUPUESTO', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(p.numero || 'N/A', 70, yPos);

                yPos += 6;
                doc.setFont('helvetica', 'bold');
                doc.text('Fecha:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(p.fecha, 70, yPos);

                yPos += 6;
                doc.setFont('helvetica', 'bold');
                doc.text('Vigencia:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(p.vigencia + ' días desde la fecha de emisión', 70, yPos);

                yPos += 15;

                // DATOS DEL CLIENTE
                doc.setFillColor(...primaryColor);
                doc.rect(20, yPos - 5, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DATOS DEL CLIENTE', 22, yPos);

                yPos += 10;
                doc.setTextColor(...grayColor);
                doc.setFontSize(11);

                doc.setFont('helvetica', 'bold');
                doc.text('Nombre:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(p.cliente, 50, yPos);

                yPos += 6;
                doc.setFont('helvetica', 'bold');
                doc.text('DNI:', 20, yPos);
                doc.setFont('helvetica', 'normal');
                doc.text(p.dni || 'N/A', 50, yPos);

                if (p.email) {
                    yPos += 6;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Email:', 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(p.email, 50, yPos);
                }

                if (p.telefono) {
                    yPos += 6;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Teléfono:', 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(p.telefono, 50, yPos);
                }

                yPos += 15;

                // SERVICIO
                doc.setFillColor(...primaryColor);
                doc.rect(20, yPos - 5, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('SERVICIO JURÍDICO', 22, yPos);

                yPos += 10;
                doc.setTextColor(...grayColor);
                doc.setFontSize(11);

                doc.setFont('helvetica', 'bold');
                doc.text('Área/Servicio:', 20, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                doc.text(p.servicio, 20, yPos);

                yPos += 10;
                doc.setFont('helvetica', 'bold');
                doc.text('Descripción:', 20, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                const descripcionLines = doc.splitTextToSize(p.descripcion, 170);
                doc.text(descripcionLines, 20, yPos);
                yPos += (descripcionLines.length * 6) + 10;

                // TABLA DE HONORARIOS
                doc.setFillColor(...primaryColor);
                doc.rect(20, yPos - 5, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('DETALLE DE HONORARIOS', 22, yPos);

                yPos += 12;

                const subtotal = p.honorarios + p.gastosAdmin;
                const ivaAmount = (subtotal * p.iva) / 100;

                doc.setTextColor(...grayColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');

                doc.text('Honorarios Profesionales', 22, yPos);
                doc.text('$ ' + p.honorarios.toLocaleString('es-AR', { minimumFractionDigits: 2 }), 188, yPos, { align: 'right' });

                yPos += 6;
                doc.text('Gastos Administrativos', 22, yPos);
                doc.text('$ ' + p.gastosAdmin.toLocaleString('es-AR', { minimumFractionDigits: 2 }), 188, yPos, { align: 'right' });

                yPos += 6;
                doc.setDrawColor(...lightGray);
                doc.line(20, yPos, 190, yPos);

                yPos += 6;
                doc.setFont('helvetica', 'bold');
                doc.text('Subtotal', 22, yPos);
                doc.text('$ ' + subtotal.toLocaleString('es-AR', { minimumFractionDigits: 2 }), 188, yPos, { align: 'right' });

                yPos += 6;
                doc.setFont('helvetica', 'normal');
                doc.text('IVA (' + p.iva + '%)', 22, yPos);
                doc.text('$ ' + ivaAmount.toLocaleString('es-AR', { minimumFractionDigits: 2 }), 188, yPos, { align: 'right' });

                yPos += 6;
                doc.setLineWidth(0.5);
                doc.line(20, yPos, 190, yPos);

                yPos += 8;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('TOTAL', 22, yPos);
                doc.text('$ ' + p.total.toLocaleString('es-AR', { minimumFractionDigits: 2 }), 188, yPos, { align: 'right' });

                yPos += 15;

                // CONDICIONES
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFillColor(...primaryColor);
                doc.rect(20, yPos - 5, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('CONDICIONES COMERCIALES', 22, yPos);

                yPos += 10;
                doc.setTextColor(...grayColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Forma de Pago:', 20, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(p.formaPago, 20, yPos);

                if (p.notas) {
                    yPos += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Observaciones:', 20, yPos);
                    yPos += 5;
                    doc.setFont('helvetica', 'normal');
                    const notasLines = doc.splitTextToSize(p.notas, 170);
                    doc.text(notasLines, 20, yPos);
                    yPos += (notasLines.length * 5) + 5;
                }

                if (p.detalleAdicional) {
                    if (yPos > 240) {
                        doc.addPage();
                        yPos = 20;
                    }
                    yPos += 5;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Detalle Adicional:', 20, yPos);
                    yPos += 5;
                    doc.setFont('helvetica', 'normal');
                    const detalleLines = doc.splitTextToSize(p.detalleAdicional, 170);
                    doc.text(detalleLines, 20, yPos);
                    yPos += (detalleLines.length * 5) + 5;
                }

                // NOTA IMPORTANTE
                yPos += 5;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100, 100, 100);
                const nota = 'NOTA: Los honorarios indicados son estimativos y podrán variar según la complejidad del caso y las gestiones necesarias. No incluyen tasas judiciales ni gastos extraordinarios que pudieran surgir durante la tramitación.';
                const notaLines = doc.splitTextToSize(nota, 170);
                doc.text(notaLines, 20, yPos);

                // PIE DE PÁGINA
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);

                    doc.setDrawColor(...lightGray);
                    doc.setLineWidth(0.5);
                    doc.line(20, 280, 190, 280);

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text('Beristain & Asociados - Estudio Jurídico', 105, 283, { align: 'center' });
                    doc.text('Dr. Leonardo Beristain - CUIT: 20-37992116-8', 105, 288, { align: 'center' });
                    doc.setFontSize(8);
                    doc.text('CPACF T146 F648 | CALM TXII F289 | CFALP T204 F114', 105, 292, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Araujo 319 - CABA | Tel: +54 11 3591-3161', 105, 296, { align: 'center' });
                    doc.text('Email: beristainyasociadosej@gmail.com', 105, 300, { align: 'center' });
                }

                // GUARDAR
                const nombreArchivo = 'Presupuesto_' + (p.numero || p.id) + '_' + p.cliente.replace(/\s+/g, '_') + '.pdf';
                doc.save(nombreArchivo);
            }

            updateStats() {
                document.getElementById('totalPresupuestos').textContent = this.presupuestos.length;
                document.getElementById('totalPendientes').textContent =
                    this.presupuestos.filter(p => p.estado === 'pendiente').length;
                document.getElementById('totalAprobados').textContent =
                    this.presupuestos.filter(p => p.estado === 'aprobado').length;

                const montoTotal = this.presupuestos.reduce((sum, p) => sum + (p.total || 0), 0);
                document.getElementById('montoTotal').textContent =
                    `$${montoTotal.toLocaleString('es-AR', { minimumFractionDigits: 0 })}`;
            }

            render() {
                const tbody = document.getElementById('presupuestosTableBody');

                if (this.presupuestos.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                                No hay presupuestos registrados. Haga clic en "Nuevo Presupuesto" para comenzar.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.presupuestos.map(p => `
                    <tr>
                        <td><strong>${p.numero || 'N/A'}</strong></td>
                        <td>${p.fecha}</td>
                        <td><strong>${p.cliente}</strong></td>
                        <td>${p.dni || 'N/A'}</td>
                        <td>${p.servicio.substring(0, 40)}${p.servicio.length > 40 ? '...' : ''}</td>
                        <td><strong>$${(p.total || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}</strong></td>
                        <td>
                            <div class="estado-selector">
                                <select onchange="manager.updateEstado(${p.id}, this.value)" class="form-control">
                                    <option value="pendiente" ${p.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="enviado" ${p.estado === 'enviado' ? 'selected' : ''}>Enviado</option>
                                    <option value="aprobado" ${p.estado === 'aprobado' ? 'selected' : ''}>Aprobado</option>
                                    <option value="rechazado" ${p.estado === 'rechazado' ? 'selected' : ''}>Rechazado</option>
                                </select>
                            </div>
                        </td>
                        <td style="white-space: nowrap;">
                            <button class="btn-action btn-view" onclick="manager.viewDetails(${p.id})" title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="manager.editPresupuesto(${p.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn-action btn-pdf" onclick="manager.exportToPDF(${p.id})" title="Exportar PDF">
                                <i class="bi bi-file-pdf"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="manager.deletePresupuesto(${p.id})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            resetForm() {
                document.getElementById('presupuestoForm').reset();
                document.getElementById('presupuestoId').value = '';
                document.getElementById('formTitle').innerHTML = '<i class="bi bi-file-earmark-plus me-2"></i>Crear Nuevo Presupuesto';
                document.getElementById('btnSubmitText').textContent = 'Guardar Presupuesto';
                this.editingId = null;
                calcularTotal();
            }

            init() {
                this.updateStats();
                this.render();

                document.getElementById('btnNuevoPresupuesto').addEventListener('click', () => {
                    this.resetForm();
                    document.getElementById('formPresupuesto').classList.add('active');
                    document.getElementById('formPresupuesto').scrollIntoView({ behavior: 'smooth' });
                });

                document.getElementById('btnCancelar').addEventListener('click', () => {
                    document.getElementById('formPresupuesto').classList.remove('active');
                    this.resetForm();
                });

                document.getElementById('presupuestoForm').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const totalText = document.getElementById('totalEstimado').value.replace(/\./g, '').replace(',', '.');
                    const saldoVal = document.getElementById('saldo').value;

                    const formData = {
                        cliente: document.getElementById('cliente').value,
                        dni: document.getElementById('dni').value,
                        email: document.getElementById('email').value,
                        telefono: document.getElementById('telefono').value,
                        servicio: document.getElementById('servicio').value,
                        descripcion: document.getElementById('descripcion').value,
                        valorUMA: document.getElementById('valorUMA').value,
                        cantidadUMA: document.getElementById('cantidadUMA').value,
                        honorarios: document.getElementById('honorarios').value,
                        gastosAdmin: document.getElementById('gastosAdmin').value,
                        iva: document.getElementById('iva').value,
                        anticipo: document.getElementById('anticipo').value,
                        saldo: saldoVal,
                        total: totalText,
                        formaPago: document.getElementById('formaPago').value,
                        cuotas: document.getElementById('cuotas').value,
                        vigencia: document.getElementById('vigencia').value,
                        vencimiento: document.getElementById('vencimiento').value,
                        notas: document.getElementById('notas').value,
                        detalleAdicional: document.getElementById('detalleAdicional').value
                    };

                    const editingId = document.getElementById('presupuestoId').value;
                    if (editingId) {
                        this.updatePresupuesto(parseInt(editingId), formData);
                    } else {
                        this.addPresupuesto(formData);
                    }

                    document.getElementById('formPresupuesto').classList.remove('active');
                    this.resetForm();
                });
            }
        }

        // Inicializar
        const manager = new PresupuestosManager();
        window.manager = manager;

        // Cerrar modal
        function closeModal() {
            document.getElementById('modalDetalles').classList.remove('active');
        }

        document.getElementById('modalDetalles').addEventListener('click', (e) => {
            if (e.target.id === 'modalDetalles') {
                closeModal();
            }
        });
    </script>
</body>
</html>
